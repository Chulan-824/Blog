# 事务

## 介绍

**事务**是一组操作的集合，它是一个不可分割的工作单位。事务会把所有的操作作为一个整体，一起向数据库提交或者是撤销操作请求。所以这组操作要么同时成功，要么同时失败。

## 特性

- 原子性：事务中的所有操作要么全部完成，要么全部不完成
- 一致性：事务执行前后，数据库都处于一致的状态
- 隔离性：事务的执行不应受到其他事务的影响
- 持久性：事务一旦提交，对数据库的更改是永久性的

怎么样来控制这组操作，让这组操作同时成功或同时失败呢？此时就要涉及到事务的具体操作了。

事务的操作主要有三步：

1. 开启事务（一组操作开始前，开启事务）：start transaction / begin
2. 提交事务（这组操作全部成功后，提交事务）：commit
3. 回滚事务（中间任何一个操作出现异常，回滚事务）：rollback

## Transactional 注解

作用：当前方法执行开始之前开启事务，方法执行完毕之后提交事务。如果在这个方法执行的过程当中出现了异常，就会进行事务的回滚操作。

> 一般会在业务层当中来控制事务，因为在业务层当中，一个业务功能可能会包含多个数据访问的操作。在业务层来控制事务，我们就可以将多个数据访问操作控制在一个事务范围内。

@Transactional注解书写位置：

- 方法：当前方法交给 spring 进行事务管理
- 类：当前类中所有的方法都交由 spring 进行事务管理
- 接口：接口下所有的实现类当中所有的方法都交给 spring 进行事务管理

::: code-group

```java{2,3} [A]
public class A {
  @Transactional
  public void aMethod(){
    B b = new B();

    b.bMethod();
  }
}
```

```java [B]
public class B {
  void bMethod() {
    // do something
  }
}
```

:::

## 常用配置参数

| 属性名      | 说明                                                                                       |
| ----------- | ------------------------------------------------------------------------------------------ |
| propagation | 事务的传播行为，默认值为 REQUIRED                                                          |
| isolation   | 事务的隔离级别，默认值采用 DEFAULT                                                         |
| timeout     | 事务的超时时间，默认值为-1（不会超时）。如果超过该时间限制但事务还没有完成，则自动回滚事务 |
| readOnly    | 指定事务是否为只读事务，默认值为 false                                                     |
| rollbackFor | 用于指定能够触发事务回滚的异常类型，并且可以指定多个异常类型                               |
|             |

### propagation

| **属性值**       | **含义**                                                           |
| ---------------- | ------------------------------------------------------------------ |
| **REQUIRED**     | 【默认值】需要事务，有则加入，无则创建新事务                       |
| **REQUIRES_NEW** | 需要新事务，无论有无，总是创建新事务                               |
| SUPPORTS         | 支持事务，有则加入，无则在无事务状态中运行                         |
| NOT_SUPPORTED    | 不支持事务，在无事务状态下运行,如果当前存在已有事务,则挂起当前事务 |
| MANDATORY        | 必须有事务，否则抛异常                                             |
| NEVER            | 必须没事务，否则抛异常                                             |

## 参考

[Spring 事务详解](https://javaguide.cn/system-design/framework/spring/spring-transaction.html)
